---
import { ThemeLink } from '@/components/link/theme-link'
import { BLOG_SLUG } from '@/consts'
import ContentLayout from '@/layouts/ContentLayout.astro'
import { getSortedPosts, type PostWithHero } from '@/lib/astro/post'

const posts = await getSortedPosts()

// Extract tags from all posts
const tagMap = new Map<number, PostWithHero[]>()

for (const post of posts) {
  const year = post.data.added.getFullYear()

  if (!tagMap.has(year)) {
    tagMap.set(year, [])
  }

  tagMap.get(year)!.push(post)
}

const tags = [...tagMap.keys()]
  .sort((a, b) => {
    let d = tagMap.get(a)!.length - tagMap.get(b)!.length

    if (d !== 0) {
      return d
    }

    return a.toString().localeCompare(b.toString())
  })
  .reverse()

//const tags = numSort([...tagMap.keys()]).reverse() // Sort years in descending order
---

<ContentLayout
  title="Years"
  description="This page lists all years used in the blog posts."
>
  <main slot="main" class="flex flex-col gap-y-8">
    <h1 class="text-2xl font-bold">Years</h1>
    <ul>
      {
        tags.map(tag => {
          const n = tagMap.get(tag)?.length ?? 0
          return (
            <li>
              <ThemeLink href={`${BLOG_SLUG}/year/${tag}/`}>{tag}</ThemeLink>{' '}
              {`(${n.toLocaleString()} post${n !== 1 ? 's' : ''})`}
            </li>
          )
        })
      }
    </ul>
  </main>
</ContentLayout>

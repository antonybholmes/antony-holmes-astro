---
import { BLOG_SLUG } from '@/consts'
import BlogPostsLayout from '@/layouts/BlogPostsLayout.astro'
import { getSortedPosts, type PostWithHero } from '@/lib/astro/post'
import { paginate, type AstroPage } from '@/lib/paginate'
import { produce } from 'immer'

// 1. Generate all unique tags for static paths
export async function getStaticPaths() {
  const posts = await getSortedPosts()

  // params need to be strings so we convert the year to a string
  // and use a Set to ensure uniqueness
  const yearSet = new Set<number>()
  for (const post of posts) {
    yearSet.add(post.data.added.getFullYear())

    if (post.data.updated) {
      // if the post has an updated date, add that year as well
      // to ensure we include posts that were updated in a different year
      // than they were added
      yearSet.add(post.data.updated.getFullYear())
    }
  }

  let paths: AstroPage<PostWithHero>[] = []

  for (const year of yearSet) {
    const slug = year.toString()
    const filteredPosts = posts
      .filter(
        post =>
          post.data.added.getFullYear() === year ||
          post.data.updated?.getFullYear() === year
      )
      .sort((a, b) => {
        return b.data.added.getTime() - a.data.added.getTime()
      })

    paths = paths.concat(
      paginate(filteredPosts, { slug, title: `Posts from ${year}` }).map(p =>
        produce(p, draft => {
          draft.props.root = `${BLOG_SLUG}/year/${slug}`
        })
      )
    )
  }

  return paths
}

const { title, pageTitle, page, root, pages, data } = Astro.props
---

<BlogPostsLayout
  title={title!}
  pageTitle={pageTitle}
  page={page}
  pages={pages}
  posts={data}
  root={root!}
  showTitle={true}
/>

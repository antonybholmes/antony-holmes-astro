---
import BlogPostsLayout from '@/layouts/BlogPostsLayout.astro'
import { getTimePostMap } from '@/lib/astro/time'
import { getTimeBaseUrl } from '@/lib/http/urls'
import { getSortedPosts } from '@lib/astro/post'
import { paginate } from '@lib/paginate'

import type { CollectionEntry } from 'astro:content'

export async function getStaticPaths() {
  const allPosts = await getSortedPosts()

  const tagMap = await getTimePostMap(allPosts)

  let paths: {
    params: { slug?: string }
    props: {
      title: string
      pageTitle: string
      showTitle: boolean
      root: string
      page: number
      pages: number
      data: CollectionEntry<'blog'>[]
    }
  }[] = []

  for (const [time, posts] of tagMap.entries()) {
    paths = paths.concat(
      paginate(posts, `${time}-min`).map(p => ({
        ...p,
        props: {
          ...p.props,
          title: `${time} min read`,
          pageTitle: `${time} min read - Page ${p.props.page + 1} of ${p.props.pages}`,
          showTitle: true,
          root: getTimeBaseUrl(time),
        },
      }))
    )
  }

  return paths
}

const { title, pageTitle, page, root, pages, data } = Astro.props
---

<BlogPostsLayout
  title={title}
  pageTitle={pageTitle}
  page={page}
  pages={pages}
  posts={data}
  root={root}
  showTitle={true}
/>

---
import BlogPostsLayout from '@/layouts/BlogPostsLayout.astro'
import { getTagPostMap } from '@/lib/astro/tags'
import { getUrlFriendlyTag } from '@/lib/http/urls'
import { getSortedPosts, type PostWithHero } from '@lib/astro/post'
import { paginate, type AstroPage } from '@lib/paginate'

import { capitalCase } from '@/lib/text/capital-case'
import { fixName } from '@/lib/text/text'
import { getTagBaseUrl } from '@lib/http/urls'
import { produce } from 'immer'

export async function getStaticPaths() {
  const allPosts = await getSortedPosts()

  const tagMap = getTagPostMap(allPosts)

  let paths: AstroPage<PostWithHero>[] = []

  for (const [tag, posts] of tagMap.entries()) {
    const title = fixName(capitalCase(tag))
    paths = paths.concat(
      paginate(posts, {
        slug: getUrlFriendlyTag(tag),
        title,
      }).map(p =>
        produce(p, draft => {
          draft.props.root = getTagBaseUrl(tag)
        })
      )
    )
  }

  return paths
}

const { title, pageTitle, page, root, pages, data } = Astro.props
---

<BlogPostsLayout
  title={title!}
  pageTitle={pageTitle}
  page={page}
  pages={pages}
  posts={data}
  root={root!}
  showTitle={true}
/>

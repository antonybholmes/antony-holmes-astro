---
import BlogPostsLayout from '@/layouts/BlogPostsLayout.astro'
import { getTagPostMap } from '@/lib/astro/tags'
import { getUrlFriendlyTag } from '@/lib/http/urls'
import { getSortedPosts } from '@lib/astro/post'
import { paginate } from '@lib/paginate'

import { capitalCase } from '@/lib/text/capital-case'
import { fixName } from '@/lib/text/text'
import { getTagBaseUrl } from '@lib/http/urls'
import type { CollectionEntry } from 'astro:content'

export async function getStaticPaths() {
  const allPosts = await getSortedPosts()

  const tagMap = getTagPostMap(allPosts)

  let paths: {
    params: { slug?: string }
    props: {
      title: string
      pageTitle: string
      showTitle: boolean
      root: string
      page: number
      pages: number
      data: CollectionEntry<'blog'>[]
    }
  }[] = []

  for (const [tag, posts] of tagMap.entries()) {
    const title = fixName(capitalCase(tag))
    paths = paths.concat(
      paginate(posts, getUrlFriendlyTag(tag)).map(p => ({
        ...p,
        props: {
          ...p.props,
          title: `${title} Posts`,
          pageTitle: `${title} - Page ${p.props.page + 1} of ${p.props.pages}`,
          showTitle: true,
          root: getTagBaseUrl(tag),
        },
      }))
    )
  }

  return paths
}

const { title, pageTitle, page, root, pages, data } = Astro.props
---

<BlogPostsLayout
  title={title}
  pageTitle={pageTitle}
  page={page}
  pages={pages}
  posts={data}
  root={root}
  showTitle={true}
/>
